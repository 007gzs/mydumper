cmake_minimum_required(VERSION 2.6)
project(mydumper)
set(VERSION 0.1.7)
set(ARCHIVE_NAME "${CMAKE_PROJECT_NAME}-${VERSION}")

#Required packages
set(CMAKE_MODULE_PATH ${CMAKE_SOURCE_DIR}/cmake/modules)
find_package(MySQL)
find_package(GLIB2)
find_package(PCRE)

set(CMAKE_C_FLAGS "-Wall -Werror -O3 -g")

include_directories(${MYDUMPER_SOURCE_DIR} ${MYSQL_INCLUDE_DIR} ${GLIB2_INCLUDE_DIR} ${PCRE_INCLUDE_DIR})

IF(CMAKE_INSTALL_PREFIX_INITIALIZED_TO_DEFAULT)
SET(ORIGINAL_INSTALL_PREFIX ${CMAKE_INSTALL_PREFIX} CACHE STRING "Default prefix path" FORCE)
ENDIF()
MARK_AS_ADVANCED(ORIGINAL_INSTALL_PREFIX)

IF( NOT( VERSION VERSION_EQUAL PROJECT_VERSION) )
  SET(CMAKE_INSTALL_PREFIX "${ORIGINAL_INSTALL_PREFIX}/mydumper-${VERSION}" CACHE STRING "Install path" FORCE)
  SET(PROJECT_VERSION ${VERSION})
ENDIF() 

CONFIGURE_FILE(${CMAKE_CURRENT_SOURCE_DIR}/config.h.in ${CMAKE_CURRENT_BINARY_DIR}/config.h)

add_executable(mydumper mydumper.c)
target_link_libraries(mydumper ${MYSQL_LIBRARIES} ${GLIB2_LIBRARIES} ${GTHREAD_LIBRARIES} ${PCRE_PCRE_LIBRARY})
INSTALL(TARGETS mydumper
  RUNTIME DESTINATION bin
)

add_custom_target(dist
  COMMAND bzr export --root=${ARCHIVE_NAME}
    ${CMAKE_BINARY_DIR}/${ARCHIVE_NAME}.tar.gz
    WORKING_DIRECTORY ${CMAKE_SOURCE_DIR})
